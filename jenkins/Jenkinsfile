pipeline {
    agent any
    environment {
        // Variables de entorno para Terraform
        TF_VAR_proxmox_api_url = credentials('proxmox-api-url')
        TF_VAR_proxmox_user = credentials('proxmox-user')
        TF_VAR_proxmox_password = credentials('proxmox-password')
        TF_VAR_proxmox_node = "${params.PROXMOX_NODE}"
        
        // Configuraci√≥n de Terraform
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
        TF_CLI_ARGS = '-no-color'
        
        // Variables para la Pipeline
        TF_DIR = '/home/ubuntu/Escritorio/Prox'
    }
    
    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Acci√≥n de Terraform a ejecutar'
        )
        string(
            name: 'PROXMOX_NODE',
            defaultValue: 'prox',
            description: 'Nodo de Proxmox donde crear las VMs'
        )
        string(
            name: 'VM_COUNT',
            defaultValue: '1',
            description: 'N√∫mero de VMs a crear'
        )
        booleanParam(
            name: 'AUTO_APPROVE',
            defaultValue: false,
            description: 'Aplicar cambios autom√°ticamente sin aprobaci√≥n manual'
        )
    }
    
    stages {
        stage('üîÑ Checkout') {
            steps {
                script {
                    echo "üöÄ Iniciando pipeline para ${params.ACTION} en nodo ${params.PROXMOX_NODE}"
                }
                    dir("${TF_DIR}"){
                    }
            }
        }
        
        stage('üîß Setup Terraform') {
            steps {
                script {
                    echo "üõ†Ô∏è Configurando Terraform..."
                }
                dir("${TF_DIR}"){
                // Verificar versi√≥n de Terraform
                sh '''
                    terraform version
                    echo "üìÇ Directorio de trabajo: $(pwd)"
                    ls -la
                '''
                
                // Inicializar Terraform
                sh '''
                    echo "üîÑ Inicializando Terraform..."
                    terraform init -upgrade
                '''
            }}
        }
        
        stage('‚úÖ Validate') {
            steps {
                dir("${TF_DIR}"){
                echo "üîç Validando configuraci√≥n de Terraform..."
                
                // Validar sintaxis
                sh 'terraform validate'
                
                // Formatear c√≥digo (opcional)
                sh 'terraform fmt -check=true -diff=true'
                
                echo "‚úÖ Validaci√≥n completada exitosamente"
                }
            }
        }
        
        stage('üìã Plan') {
            when {
                anyOf {
                    expression { params.ACTION == 'plan' }
                    expression { params.ACTION == 'apply' }
                }
            }
            steps {
                dir("${TF_DIR}"){
                script {
                    echo "üìä Generando plan de Terraform..."
                    
                    // Generar plan
                    sh '''
                        terraform plan \
                            -var="vm_count=${VM_COUNT}" \
                            -out=tfplan
                    '''
                            //
                            //-detailed-exitcode
                    
                    // Mostrar resumen del plan
                    sh 'terraform show -no-color tfplan > plan_output.txt'
                    
                    // Archivar el plan para referencia
                    archiveArtifacts artifacts: 'plan_output.txt', fingerprint: true
                    
                    echo "üìã Plan generado y guardado"
                }
                }
            }
        }
        
        stage('üö¶ Approval') {
            when {
                allOf {
                    expression { params.ACTION == 'apply' }
                    expression { params.AUTO_APPROVE == false }
                }
            }
            steps {
                dir("${TF_DIR}"){
                script {
                    echo "‚è≥ Esperando aprobaci√≥n manual..."
                    
                    // Mostrar resumen antes de la aprobaci√≥n
                    sh 'terraform show -no-color tfplan | head -50'
                    
                    // Solicitar aprobaci√≥n
                    input message: '¬øDeseas aplicar estos cambios en Proxmox?', 
                          ok: '‚úÖ Aplicar cambios',
                          submitterParameter: 'APPROVER'
                    
                    echo "‚úÖ Cambios aprobados por: ${env.APPROVER}"
                }
                }
            }
        }
        
        stage('üöÄ Apply') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${TF_DIR}"){
                script {
                    echo "üî• Aplicando cambios en Proxmox..."
                    
                    // Aplicar el plan
                    sh 'terraform apply tfplan'
                    
                    // Guardar outputs
                    sh 'terraform output -json > terraform_outputs.json'
                    
                    // Archivar outputs
                    archiveArtifacts artifacts: 'terraform_outputs.json', fingerprint: true
                    
                    echo "üéâ Aplicaci√≥n completada exitosamente"
                }
                }
            }
        }
        
        stage('üí• Destroy') {
            when {
                expression { params.ACTION == 'destroy' }
            }
            steps {
                dir("${TF_DIR}"){
                script {
                    echo "‚ö†Ô∏è Preparando para destruir infraestructura..."
                    
                    // Mostrar qu√© se va a destruir
                    sh 'terraform plan -destroy -var="vm_count=${VM_COUNT}"'
                    
                    // Solicitar confirmaci√≥n adicional para destroy
                    input message: '‚ö†Ô∏è ¬øCONFIRMAS que quieres DESTRUIR la infraestructura?', 
                          ok: 'üí• S√ç, DESTRUIR',
                          submitterParameter: 'DESTROYER'
                    
                    echo "üí• Destrucci√≥n autorizada por: ${env.DESTROYER}"
                    
                    // Ejecutar destroy
                    sh 'terraform destroy -var="vm_count=${VM_COUNT}" -auto-approve'
                    
                    echo "üóëÔ∏è Infraestructura destruida"
                    }
                }
            }
        }
        
        stage('üîç Verify VMs') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${TF_DIR}"){
                script {
                    echo "üîç Verificando estado de las VMs..."
                    
                    // Obtener IPs de las VMs creadas
                    def vmIps = sh(
                        returnStdout: true, 
                        script: 'terraform output -json | jq -r ".vm_info.value[].ip_address"'
                    ).trim().split('\n')
                    
                    echo "üñ•Ô∏è VMs creadas con IPs: ${vmIps.join(', ')}"
                    
                    // Verificar conectividad SSH (opcional)
                    for (ip in vmIps) {
                        sh """
                            echo "üîó Verificando conectividad con ${ip}..."
                            timeout 30 bash -c 'nc -z ${ip} 22; sleep 2'
                            echo "‚úÖ VM ${ip} est√° accesible por SSH"
                        """
                    }
                }
                }
            }
        }

        stage('üîç Ansible - Playbook') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${TF_DIR}"){
                    sh 'sleep 15'
                    ansiblePlaybook installation: 'ansible', inventory: 'ansible_inventory.ini', playbook: 'apache2.yaml'
                }
            }
        }
        
        stage('üìä Generate Report') {
            steps {
                script {
                    echo "üìä Generando reporte de la ejecuci√≥n..."
                    
                    // Crear reporte HTML
                    sh '''
                        cat > deployment_report.html << EOF
<!DOCTYPE html>
<html>
<head>
    <title>Reporte de Despliegue Proxmox</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>üöÄ Reporte de Despliegue</h1>
    <p><strong>Acci√≥n:</strong> ${ACTION}</p>
    <p><strong>Nodo Proxmox:</strong> ${PROXMOX_NODE}</p>
    <p><strong>Cantidad de VMs:</strong> ${VM_COUNT}</p>
    <p><strong>Build:</strong> ${BUILD_NUMBER}</p>
    <p><strong>Fecha:</strong> $(date)</p>
    <h2>Estado: <span class="success">‚úÖ EXITOSO</span></h2>
</body>
</html>
EOF
                    '''
                    
                    // Publicar reporte HTML
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'deployment_report.html',
                        reportName: 'Reporte de Despliegue'
                    ])
                }
            }
        }
    }
    
    post {
        always {
            dir("${TF_DIR}"){
            echo "üßπ Limpiando workspace..."
            
            // Limpiar archivos temporales
            sh '''
                rm -f tfplan
                rm -f plan_output.txt
                ls -la
            '''
            
            // Archivar logs de Terraform
            archiveArtifacts artifacts: '*.log', allowEmptyArchive: true
            }
        }
        
        success {
            echo "üéâ Pipeline ejecutado exitosamente!"
            
            // Notificaci√≥n de √©xito (Slack, email, etc.)
            script {
                if (params.ACTION == 'apply') {
                    def vmCount = params.VM_COUNT
                    def message = "‚úÖ Despliegue exitoso: ${vmCount} VM(s) creada(s) en Proxmox nodo ${params.PROXMOX_NODE}"
                    
                    // Ejemplo de notificaci√≥n por Slack
                    // slackSend(channel: '#devops', color: 'good', message: message)
                    
                    echo message
                }
            }
        }
        
        failure {
            dir("${TF_DIR}"){
            echo "‚ùå Pipeline fall√≥!"
            
            // Notificaci√≥n de fallo
            script {
                def message = "‚ùå Fallo en el despliegue de Proxmox - Build #${BUILD_NUMBER}"
                
                // Ejemplo de notificaci√≥n por Slack
                // slackSend(channel: '#devops', color: 'danger', message: message)
                
                echo message
            }
            
            // Cleanup en caso de fallo durante apply
            script {
                if (params.ACTION == 'apply' && fileExists('tfplan')) {
                    echo "üßπ Limpiando recursos parcialmente creados..."
                    // sh 'terraform destroy -auto-approve' // Descomenta si quieres cleanup autom√°tico
                }
            }
            }
        }
        
        unstable {
            echo "‚ö†Ô∏è Pipeline completado con warnings"
        }
        
        cleanup {
            // Limpiar workspace al final
            cleanWs()
        }
    }
}